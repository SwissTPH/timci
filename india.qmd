---
title: "TIMCI India - intervention uptake"
format:
  pdf:
    toc: true
    number-sections: true
editor: visual
execute:
  warning: false
  echo: true
---

{{< pagebreak >}}

# Introduction

We are looking into **early/late adopter (high/low uptake)** of the devices among HCPs for sampling in India in February/March 2023.

I have asked the team to look at the following information:

-   Uptake (in %) per individual healthcare provider in respect to attendance at a facility, from start of the intervention roll-out until last month prior to data collection of Q5/late intervention data collection (e.g. December)
-   with information on number of sick children per month for the respective facility; per intervention arm, facility code and SPA/non-SPA facility.

I assume that we are eligible to look at this data as long as primary/secondary outcomes are not looked into. Correct?

If you have come across a good definition and threshold of adoption/uptake let me know. (Article published by Graham et al. on POx is known.

## Fen's thoughts

Sorry for delayed response. A few thoughts:

-   Is it possible by provider, or only by facility? (not sure if we have providers for each consultation in the LS dataset in the end - we discussed that it was important, but also challenging to operationalise) it should be but asked Samwel at IHI / Kevin in Kenya to look into it

-   You mention looking at uptake % per provider with respect to facility attendance (consultations by individual provider used device / total consultations at facility) - either this needs to be % per provider (consultations by individual provider used device / total consultations conducted by individual provider) or facility (consultations in facility in which device used / total consultations in facility) - exactly; ideally by provider; same comment as above

-   Providers (or facilities) could be low or high uptake at each time point, i.e.:

-   High then high / High then low / Low then high / Low then low actually many scenarios - we have already drawn a graphic; expecting however much more of a scribbled pattern of uptake

-   I don't think there is a good definition of 'high' or 'low', so maybe you could look at grouping uptake into quartiles and choose top and bottom quartiles? - good idea; Graham at al. decided on a definition for POx uptake

-   When you say 'from start of the intervention roll-out until last month prior to data collection of Q5/late intervention data collection' how will you define 'early' and 'late'? Perhaps Q2 = early and Q5 = late, which would mean looking at uptake for 'early' for the period end March - end June, and 'late' for the period end Dec 2022- end Mar 2023 - however given that this not practical in order to complete data collection, perhaps take 'early' as end Mar - end May and 'late' as end Nov to end Jan? I thought of of categorizing that per country; Q2 early (first three month)/Q5 late (last three month);

-   Which data will you use to define? The LS data is the only source that exists for all facilities, so assume you mean this, but SPA data may be more accurate. So if you were planning to mainly select SPA facilities, then would use that data, if both SPA and non-SPA, then look at LS. For CDSA, could consider looking rather at CDSA no.s per facility I thought of LS data but we had also discussed SPA data; the thing is that if you take the number of HCPs into consideration at SPA facilities and consider that some do not want to participate we will end up with approx. 12-15 HCPs; and then grouping does not make any sense; so we will need to expand to non-SPA facilities in any case. But thought of looking at SPA data first; selecting HCPs from there; and then expanding

{{< pagebreak >}}

# Settings

```{r}
library(openxlsx)
library(dplyr)
library(ggplot2)
library(lubridate)
```

```{r}
colors1 <- c("#333333")
sizes1 <- c(1.5)
colors3 <- c("#0396a8", "#ff9900", "#333333")
sizes3 <- c(1, 1, 1.5)
```

# TIMCI facilities

```{r}
facility_df <- openxlsx::read.xlsx("INDIA_timci_research_facilities.xlsx") %>% 
  dplyr::distinct(facility_id, .keep_all = TRUE) %>% 
  dplyr::select(facility_id,
                facility_name,
                type,
                lvl2,
                intervention,
                spa)
facility_df %>% 
  knitr::kable()
```

{{< pagebreak >}}

# Data preparation

## LS dataset

Load the LS Day 0 dataset

```{r}
df <- openxlsx::read.xlsx("INDIA_02_timci_day0_data.xlsx")
```

The Day 0 data set contains `r nrow(df)` consultations of children under 5.

```{r}
df <- df %>%
  merge(facility_df,
        by.x = "fid",
        by.y = "facility_id",
        all = FALSE) %>%
  dplyr::mutate(year = lubridate::year(date_visit))
year0 <- min(df$year)
df <- df %>%
  dplyr::mutate(month = lubridate::month(date_visit) + 12 * (year - year0)) %>%
  dplyr::mutate(week = lubridate::week(date_visit) + 52 * (year - year0)) %>% 
  dplyr::mutate(pox_done = 1 * (spo2 == 1 | spo2 == 95))
```

## SPA observation dataset

Load the SPA sick child observation dataset

```{r}
sco_df <- openxlsx::read.xlsx("INDIA_04_timci_spa_consultation_obs_data.xlsx")
colnames(sco_df) <- gsub('-*\\-', '_', colnames(sco_df))
```

The original SPA sick child observation data set contains `r nrow(sco_df)` consultations of children under 5.

```{r}
sco_df <- sco_df %>%
  merge(facility_df,
        by.x = "facility_identification_fcode",
        by.y = "facility_id",
        all = FALSE) %>%
  dplyr::filter(child_identification_back_from_lab == 0) %>% 
  dplyr::mutate(quarter = dplyr::case_when(
    as.Date(date) <= as.Date("2022-02-11") ~ "Q1",
    as.Date(date) > as.Date("2022-02-11") & as.Date(date) <= as.Date("2022-09-30") ~ "Q2",
    as.Date(date) > as.Date("2022-09-30") ~ "Q3")
  ) %>% 
  dplyr::mutate(pox_done = 1 * (meas_pox_questions_pox_meas1_res == 1))
```

The SPA sick child observation data set contains `r nrow(sco_df)` initial consultations of children under 5.

{{< pagebreak >}}

# Pulse oximetry uptake

Possible sources:

-   LS dataset (all children)
-   SPA dataset (SPA facilities only)

The pulse oximeter should be used for all paediatric consultations in India

{{< pagebreak >}}

## Uptake by week (source: LS)

### Calculations

```{r}
# Denominator
weekly_consultation_df <- df %>%
  dplyr::filter(yg_infant == 1) %>%
  dplyr::group_by(fid,
                  week,
                  intervention,
                  type,
                  lvl2) %>%
  dplyr::count() %>% 
  dplyr::rename(den = n) %>% 
  dplyr::mutate(Population = "1-59 days")

# Numerator
weekly_pox_consultation_df <- df %>%
  dplyr::filter(yg_infant == 1) %>%
  dplyr::filter(pox_done == 1) %>%
  dplyr::group_by(fid,
                  week,
                  intervention,
                  type) %>%
  dplyr::count() %>% 
  dplyr::rename(num = n) %>% 
  dplyr::mutate(Population = "1-59 days")

# Ratio
weekly_pox_yi_uptake_df <- weekly_pox_consultation_df %>%
  merge(weekly_consultation_df) %>%
  dplyr::mutate(rat = num / den)
```

```{r}
# Denominator
weekly_consultation_df <- df %>%
  dplyr::filter(yg_infant == 0) %>%
  dplyr::group_by(fid,
                  week,
                  intervention,
                  type,
                  lvl2) %>%
  dplyr::count() %>% 
  dplyr::rename(den = n) %>% 
  dplyr::mutate(Population = "2-59 months")

# Numerator
weekly_pox_consultation_df <- df %>%
  dplyr::filter(yg_infant == 0) %>%
  dplyr::filter(pox_done == 1) %>%
  dplyr::group_by(fid,
                  week,
                  intervention,
                  type) %>%
  dplyr::count() %>% 
  dplyr::rename(num = n) %>% 
  dplyr::mutate(Population = "2-59 months")

# Ratio
weekly_pox_older_uptake_df <- weekly_pox_consultation_df %>%
  merge(weekly_consultation_df) %>%
  dplyr::mutate(rat = num / den)
```

```{r}
# Denominator
weekly_consultation_df <- df %>%
  dplyr::group_by(fid,
                  week,
                  intervention,
                  type,
                  lvl2) %>%
  dplyr::count() %>% 
  dplyr::rename(den = n) %>% 
  dplyr::mutate(Population = "all")

# Numerator
weekly_pox_consultation_df <- df %>%
  dplyr::filter(pox_done == 1) %>%
  dplyr::group_by(fid,
                  week,
                  intervention,
                  type) %>%
  dplyr::count() %>% 
  dplyr::rename(num = n) %>% 
  dplyr::mutate(Population = "all")

# Ratio
weekly_pox_all_uptake_df <- weekly_pox_consultation_df %>%
  merge(weekly_consultation_df) %>%
  dplyr::mutate(rat = num / den)
```

```{r}
# Combination
weekly_pox_uptake_df <- rbind(weekly_pox_all_uptake_df,
                             weekly_pox_yi_uptake_df,
                             weekly_pox_older_uptake_df)
weekly_pox_uptake_df$Population <- factor(weekly_pox_uptake_df$Population,
                                         levels = c("1-59 days",
                                                    "2-59 months",
                                                    "all"))
```

### Early and late periods

```{r}
n_weeks <- 9
```

Create `early` and `late` variables to extract first `r n_weeks` weeks and last `r n_weeks` weeks of the data collection.

```{r}
min_week <- min(weekly_pox_uptake_df$week)
max_week <- max(weekly_pox_uptake_df$week)
weekly_pox_uptake_df <- weekly_pox_uptake_df %>% 
  dplyr::mutate(early = 1 * (week <= min_week + n_weeks)) %>% 
  dplyr::mutate(late = 1 * (week >= max_week - n_weeks + 1))
```

```{r}
weekly_pox_uptake_early_df <- weekly_pox_uptake_df %>%
  dplyr::filter(intervention == 1) %>%
  dplyr::filter(early == 1) %>%
  dplyr::group_by(fid, lvl2, type) %>%
  dplyr::summarise_at(vars(rat), list(early_rat = median))
weekly_pox_uptake_late_df <- weekly_pox_uptake_df %>%
  dplyr::filter(intervention == 1) %>%
  dplyr::filter(late == 1) %>%
  dplyr::group_by(fid) %>%
  dplyr::summarise_at(vars(rat), list(late_rat = median))
weekly_pox_uptake_comb_df <- weekly_pox_uptake_early_df %>% 
                                merge(weekly_pox_uptake_late_df,
                                      by = "fid")
n <- nrow(weekly_pox_uptake_comb_df)
weekly_pox_uptake_comb_df <- weekly_pox_uptake_comb_df %>%
  dplyr::arrange(late_rat, early_rat) %>%
  dplyr::mutate(rank = dplyr::dense_rank(interaction(late_rat, early_rat,lex.order=T))) %>%
  dplyr::mutate(uptake_ctg = dplyr::case_when(
    rank <= round(0.25*n)                        ~ "low",
    rank > round(0.25*n) & rank <= round(0.75*n) ~ "medium",
    TRUE                                         ~ "high"
    )
  )
weekly_pox_uptake_comb_df %>% 
  knitr::kable()
```

### Plots

Weekly pulse oximetry uptakes for PHCs are displayed in @fig-weekly-pox-disp, while weekly pulse oximetry uptakes for CHCs are displayed in @fig-weekly-pox-hc.

```{r}
#| fig-height: 8
#| fig-width: 9
#| fig-cap: "Weekly pulse oximetry uptake in PHCs"
#| label: fig-weekly-pox-disp
p <- ggplot2::ggplot(weekly_pox_uptake_df %>%
                       dplyr::filter(type == "PHC"),
                     ggplot2::aes(x = week,
                                  y = rat,
                                  color = Population,
                                  size = Population)) +
  ggplot2::geom_line() +
  ggplot2::scale_color_manual(values = colors3) +
  ggplot2::scale_size_manual(values = sizes3) +
  ggplot2::theme_classic() +
  ggplot2::theme(legend.position="bottom") +
  ggplot2::ylim(0,1) +
  ggplot2::facet_wrap(~ fid, nrow = 4)

p
```

```{r}
#| fig-height: 8
#| fig-width: 9
#| fig-cap: "Weekly pulse oximetry uptake in health centres"
#| label: fig-weekly-pox-hc
p <- ggplot2::ggplot(weekly_pox_uptake_df %>%
                       dplyr::filter(type == "CHC"),
                     ggplot2::aes(x = week,
                                  y = rat,
                                  color = Population,
                                  size = Population)) +
  ggplot2::geom_line() +
  ggplot2::scale_color_manual(values = colors3) +
  ggplot2::scale_size_manual(values = sizes3) +
  ggplot2::theme_classic() +
  ggplot2::theme(legend.position="bottom") +
  ggplot2::ylim(0,1) +
  ggplot2::facet_wrap(~ fid, nrow = 4)

p
```

### Comments from Anmol

Type here

{{< pagebreak >}}

## SPA dataset

### Calculations

```{r}
# Denominator
weekly_consultation_df <- sco_df %>%
  dplyr::group_by(facility_identification_fcode,
                  hcp_identification_hcpid,
                  quarter,
                  type) %>%
  dplyr::count() %>% 
  dplyr::rename(den = n) %>% 
  dplyr::mutate(Population = "all")

# Numerator
weekly_pox_consultation_df <- sco_df %>%
  dplyr::filter(pox_done == 1) %>%
  dplyr::group_by(facility_identification_fcode,
                  hcp_identification_hcpid,
                  quarter,
                  type) %>%
  dplyr::count() %>% 
  dplyr::rename(num = n) %>% 
  dplyr::mutate(Population = "all")

# Ratio
weekly_pox_all_uptake_df <- weekly_pox_consultation_df %>%
  merge(weekly_consultation_df) %>%
  dplyr::mutate(rat = num / den)
```

### Plots

Weekly pulse oximetry uptakes for PHCs are displayed in @fig-weekly-pox-disp3, while weekly pulse oximetry uptakes for CHCs are displayed in @fig-weekly-pox-hc3.

```{r}
#| fig-height: 8
#| fig-width: 9
#| fig-cap: "Weekly pulse oximetry uptake in PHCs"
#| label: fig-weekly-pox-disp3
p <- ggplot2::ggplot(weekly_pox_all_uptake_df %>%
                       dplyr::filter(type == "PHC"),
                     ggplot2::aes(x = quarter,
                                  y = rat,
                                  color = hcp_identification_hcpid,
                                  group = hcp_identification_hcpid)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::theme_classic() +
  ggplot2::theme(legend.position="bottom") +
  ggplot2::ylim(0,1) +
  ggplot2::facet_wrap(~ facility_identification_fcode, nrow = 4)

p
```

```{r}
#| fig-height: 8
#| fig-width: 9
#| fig-cap: "Weekly pulse oximetry uptake in CHCs"
#| label: fig-weekly-pox-hc3
p <- ggplot2::ggplot(weekly_pox_all_uptake_df %>%
                       dplyr::filter(type == "CHC"),
                     ggplot2::aes(x = quarter,
                                  y = rat,
                                  color = hcp_identification_hcpid,
                                  group = hcp_identification_hcpid)) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::theme_classic() +
  ggplot2::theme(legend.position="bottom") +
  ggplot2::ylim(0,1) +
  ggplot2::facet_wrap(~ facility_identification_fcode, nrow = 4)

p
```
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
1 + 1
```

You can add options to executable code like this

```{r}
#| echo: false
2 * 2
```

The `echo: false` option disables the printing of code (only output is displayed).
