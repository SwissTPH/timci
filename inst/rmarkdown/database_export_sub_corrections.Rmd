---
title: "Database export - corrections "
author: "H. LANGET"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M GMT%z')`"
---

<!-- Initialisation -->

```{r}
out <- to_correct_df
corrected_df <- NULL
edited_records <- NULL
valid_edits <- NULL
non_valid_edits <- NULL
valid_is_not_empty <- FALSE
valid_partial_disp <- FALSE
valid_full_disp <- FALSE
non_valid_is_not_empty <- FALSE
non_valid_partial_disp <- FALSE
non_valid_full_disp <- FALSE
n_mc <- 0
mc_status_update <- ""
```

```{r}
corrections_from_field <- c("edit_day0_child_ids_to_correct_facilities_from_field_info",
                            "correct_device_ids")
is_not_from_field <- (!correction_type %in% corrections_from_field)
```

---

**Manual corrections**

**Description**: `r mc_description`

<!-- Type of possible corrections -->

```{r, eval=(correction_type=="correct_device_ids")}
out <- timci::correct_device_ids(to_correct_df)
```

```{r, eval=(correction_type=="convert_screening_from_day0_to_repeat")}
out <- timci::edit_day0_to_repeat(to_correct_df)

# Parameters for the quality check following manual corrections
qc_rule <- action_alert_no_modification
```

```{r, eval=(correction_type=="edit_day0_child_ids_to_correct_facilities_from_check")}
out <- timci::edit_day0_child_ids(to_correct_df, csv_prefix = "day0_childID_correction_inconsistent_facility_check")

# Parameters for the quality check following manual corrections
qc_rule <- action_alert_no_modification
```

```{r, eval=(correction_type=="edit_day0_child_ids_to_correct_facilities_from_field_info")}
out <- timci::edit_day0_child_ids(to_correct_df, csv_prefix = "day0_childID_correction_from_field")
```

```{r, eval=(correction_type=="edit_day0_child_ids_to_correct_duplicates")}
out <- timci::edit_day0_child_ids(to_correct_df, csv_prefix = "day0_duplicate_correction")
```

```{r, eval=is_senegal&(correction_type=="correct_day0_inconsistent_facilities")}
out <- timci::correct_day0_inconsistent_facilities(to_correct_df)
```

```{r, eval=is_tanzania&(correction_type=="correct_day0_inconsistent_facilities")}
out <- timci::correct_day0_inconsistent_facilities(to_correct_df)
```

<!-- Display summary of valid and non-valid edits that were done -->

```{r, eval=!is.null(out)}
corrected_df <- out[[1]]
edited_records <- out[[2]]
```

```{r}
edit_is_not_empty <- timci::is_not_empty(edited_records)
```

```{r, eval=edit_is_not_empty}
cols <- colnames(edited_records)
disp_cols <- c()
if ( 'child_id' %in% cols ) {
  disp_cols <- c(disp_cols, "child_id")
}
if ( 'old_child_id' %in% cols ) {
  disp_cols <- c(disp_cols, "old_child_id")
}
disp_cols <- c(disp_cols, "uuid")
if ( 'new_child_id' %in% cols ) {
  disp_cols <- c(disp_cols, "new_child_id")
}
if ( 'new_fid' %in% cols ) {
  disp_cols <- c(disp_cols, "new_fid")
}
n_corrected <- nrow(edited_records)
```

```{r, eval=edit_is_not_empty&is_not_from_field&(correction_type!="edit_day0_child_ids_to_correct_duplicates")}
valid_edits <- edited_records[edited_records$uuid %in% qc_reuse_df$uuid,]
valid_is_not_empty <- timci::is_not_empty(valid_edits)
non_valid_edits <- edited_records[!edited_records$uuid %in% qc_reuse_df$uuid,]
non_valid_is_not_empty <- timci::is_not_empty(non_valid_edits)
```

```{r, eval=edit_is_not_empty&is_not_from_field&(correction_type=="edit_day0_child_ids_to_correct_duplicates")}
uuid_cols <- grep("uuid", names(qc_reuse_df))
valid_edits <- edited_records[edited_records$uuid %in% unname((unlist(qc_reuse_df[colnames(qc_reuse_df[uuid_cols])]))),]
valid_is_not_empty <- timci::is_not_empty(valid_edits)
non_valid_edits <- edited_records[!edited_records$uuid %in% unname((unlist(qc_reuse_df[colnames(qc_reuse_df[uuid_cols])]))),]
non_valid_is_not_empty <- timci::is_not_empty(non_valid_edits)
```

```{r, eval=valid_is_not_empty}
valid_partial_disp <- valid_is_not_empty & ( nrow(valid_edits) > 10 )
valid_full_disp <- valid_is_not_empty & ( nrow(valid_edits) <= 10 )
```

```{r, eval=non_valid_is_not_empty}
non_valid_partial_disp <- non_valid_is_not_empty & ( nrow(non_valid_edits) > 10 )
non_valid_full_disp <- non_valid_is_not_empty & ( nrow(non_valid_edits) <= 10 )
```

```{r, eval=edit_is_not_empty}
mc_status_update <- paste0('**', n_corrected, '** record(s) were manually edited in the ', db_name, ' database: **', nrow(valid_edits), '** edits that corrected instances detected by the check and **', nrow(non_valid_edits),'** edits that corrected instances not detected by the check.')
```

`r mc_status_update`

```{r, eval=valid_full_disp, results='asis'}
valid_edits %>%
  dplyr::select(disp_cols) %>%
  knitr::kable(row.names = FALSE,
               caption = "Edits that correct records detected by the check")
```

```{r, eval=valid_partial_disp, results='asis'}
valid_edits %>%
  dplyr::select(disp_cols) %>%
  head(5) %>%
  knitr::kable(row.names = FALSE,
               caption = "Five first rows of edits that correct records detected by the check")
```

```{r, eval=valid_partial_disp, results='asis'}
cat("...")
```

```{r, eval=valid_partial_disp, results='asis'}
valid_edits %>%
  dplyr::select(disp_cols) %>%
  tail(5) %>%
  knitr::kable(row.names = FALSE,
               caption = "Five last rows of edits that correct records detected by the check")
```

```{r, eval=non_valid_full_disp, results='asis'}
non_valid_edits %>%
  dplyr::select(disp_cols) %>%
  knitr::kable(row.names = FALSE,
               caption = "Edits that correct records NOT detected by the check")
```

```{r, eval=non_valid_partial_disp, results='asis'}
non_valid_edits %>%
  dplyr::select(disp_cols) %>%
  head(5) %>%
  knitr::kable(row.names = FALSE,
               caption = "Five first rows of edits that correct records NOT detected by the check")
```

```{r, eval=non_valid_partial_disp, results='asis'}
cat("...")
```

```{r, eval=non_valid_partial_disp, results='asis'}
non_valid_edits %>%
  dplyr::select(disp_cols) %>%
  tail(5) %>%
  knitr::kable(row.names = FALSE,
               caption = "Five last rows of edits that correct records NOT detected by the check")
```

<!-- Quality check run after manual edits -->

`r if (is_not_from_field) { paste0('---') }`

`r if (is_not_from_field) { paste0('**Final check after manual edits ', qc_idx, '**') }`

```{r, eval=is_not_from_field, results='asis'}
df <- corrected_df
qc_export_label <- paste0(qc_export_label, "_after_manual_edits")
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```
