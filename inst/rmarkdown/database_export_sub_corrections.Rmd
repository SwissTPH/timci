---
title: "Database export - corrections "
author: "H. LANGET"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M GMT%z')`"
---

```{r}
edited_records <- NULL
valid_edits <- NULL
non_valid_edits <- NULL
valid_is_not_empty <- FALSE
valid_partial_disp <- FALSE
valid_full_disp <- FALSE
non_valid_is_not_empty <- FALSE
non_valid_partial_disp <- FALSE
non_valid_full_disp <- FALSE
edited_df_status_update <- ""
```

```{r, eval=(correction_type=="edit_day0_child_ids_to_correct_facilities")}
out <- timci::edit_day0_child_ids(day0_data, wf = TRUE)
edited_df <- out[[1]]
edited_records <- out[[2]]
```

```{r, eval=(correction_type=="edit_day0_child_ids_to_correct_duplicates")}
out <- timci::edit_day0_child_ids(day0_data)
edited_df <- out[[1]]
edited_records <- out[[2]]
```

```{r, eval=is_senegal&(correction_type=="correct_day0_inconsistent_facilities")}
out <- timci::correct_day0_inconsistent_facilities(day0_data)
edited_df <- out[[1]]
edited_records <- out[[2]]
```

```{r, eval=is_tanzania&(correction_type=="correct_day0_inconsistent_facilities")}
out <- timci::correct_day0_inconsistent_facilities(day0_data)
edited_df <- out[[1]]
edited_records <- out[[2]]
```

```{r}
edit_is_not_empty <- timci::is_not_empty(edited_records)
```

```{r, eval=edit_is_not_empty}
cols <- colnames(edited_records)
disp_cols <- c()
if ( 'child_id' %in% cols ) {
  disp_cols <- c(disp_cols, "child_id")
}
if ( 'old_child_id' %in% cols ) {
  disp_cols <- c(disp_cols, "old_child_id")
}
disp_cols <- c(disp_cols, "uuid")
if ( 'new_child_id' %in% cols ) {
  disp_cols <- c(disp_cols, "new_child_id")
}
if ( 'new_fid' %in% cols ) {
  disp_cols <- c(disp_cols, "new_fid")
}
```

```{r, eval=(correction_type!="edit_day0_child_ids_to_correct_duplicates")}
uuid_cols <- grep("uuid", names(qc_reuse_df))
```

```{r, eval=edit_is_not_empty&(correction_type!="edit_day0_child_ids_to_correct_duplicates")}
valid_edits <- edited_records[edited_records$uuid %in% qc_reuse_df$uuid,]
valid_is_not_empty <- timci::is_not_empty(valid_edits)
non_valid_edits <- edited_records[!edited_records$uuid %in% qc_reuse_df$uuid,]
non_valid_is_not_empty <- timci::is_not_empty(non_valid_edits)
```

```{r, eval=edit_is_not_empty&(correction_type=="edit_day0_child_ids_to_correct_duplicates")}
valid_edits <- edited_records[edited_records$uuid %in% unname((unlist(qc_reuse_df[colnames(qc_reuse_df[uuid_cols])]))),]
valid_is_not_empty <- timci::is_not_empty(valid_edits)
non_valid_edits <- edited_records[!edited_records$uuid %in% unname((unlist(qc_reuse_df[colnames(qc_reuse_df[uuid_cols])]))),]
non_valid_is_not_empty <- timci::is_not_empty(non_valid_edits)
```

```{r, eval=valid_is_not_empty}
valid_partial_disp <- valid_is_not_empty & ( nrow(valid_edits) > 10 )
valid_full_disp <- valid_is_not_empty & ( nrow(valid_edits) <= 10 )
```

```{r, eval=edit_is_not_empty}
edited_df_status_update <- paste0('**', nrow(edited_records), '** record(s) were manually edited in the ', db_name, ' database.')
```

`r edited_df_status_update`

```{r, eval=valid_full_disp, results='asis'}
valid_edits %>%
  dplyr::select(disp_cols) %>%
  knitr::kable(row.names = FALSE,
               caption = "Edits that correct records detected by the check")
```

```{r, eval=valid_partial_disp, results='asis'}
valid_edits %>%
  dplyr::select(disp_cols) %>%
  head(5) %>%
  knitr::kable(row.names = FALSE,
               caption = "Five first rows of edits that correct records detected by the check")
```

```{r, eval=valid_partial_disp, results='asis'}
cat("...")
```

```{r, eval=valid_partial_disp, results='asis'}
valid_edits %>%
  dplyr::select(disp_cols) %>%
  tail(5) %>%
  knitr::kable(row.names = FALSE,
               caption = "Five last rows of edits that correct records detected by the check")
```

```{r, eval=non_valid_full_disp, results='asis'}
non_valid_edits %>%
  dplyr::select(disp_cols) %>%
  knitr::kable(row.names = FALSE,
               caption = "Edits that correct records NOT detected by the check")
```

```{r, eval=non_valid_partial_disp, results='asis'}
non_valid_edits %>%
  dplyr::select(disp_cols) %>%
  head(5) %>%
  knitr::kable(row.names = FALSE,
               caption = "Five first rows of edits that correct records NOT detected by the check")
```

```{r, eval=non_valid_partial_disp, results='asis'}
cat("...")
```

```{r, eval=non_valid_partial_disp, results='asis'}
non_valid_edits %>%
  dplyr::select(disp_cols) %>%
  tail(5) %>%
  knitr::kable(row.names = FALSE,
               caption = "Five last rows of edits that correct records NOT detected by the check")
```
