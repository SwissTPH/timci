```{r}
write("o Export drug re-entry data and run corresponding quality checks", stderr())
```

\newpage

## Drug free text re-entry data quality checks and cleaning

```{r}
db_name <- "Drug"
drug_is_not_null <- timci::is_not_empty(raw_drug_data)
n_raw_drug_records <- nrow(raw_drug_data)
```

There are **`r n_raw_drug_records`** record(s) in the raw `r db_name` database.

### Duplicated entries [Compliance check `r qc_duplicate_drug`]

```{r}
write("\to Duplicate check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All participants should have a distinct ID. Duplicated IDs may generate errors for the conduct of follow-ups in the field and results in ambiguous outcomes for duplicated participants once the database is deidentified."
qc_rule <- "Remaining duplicated record IDs are deleted from the database."
qc_type <- "duplicates"
df <- raw_drug_data
col_id <- "uuid"
col_date <- "start"
cleaning <- "keep_latest"
qc_text <- "duplicated IDs"
qc_idx <- qc_duplicate_drug
qc_export_label <- "drug_id_duplicates"
qc_export_description <- "the submission was done twice for the same record ID"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_dropped_duplicate_records <- n_detected
```

```{r, eval=!is.null(cleaned_df)}
drug_data <- cleaned_df
n_cleaned_drug_records <- nrow(drug_data)
```

### Amoxicillin entries [Expert knowledge checks `r qc_amox_consistency_drug`]

```{r}
write("\to Amoxicillin check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Amoxicillin."
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_amoxicillin"
cleaning <- "none"
qc_text <- "amoxicillin entries"
qc_idx <- qc_amox_consistency_drug
qc_export_label <- "amoxicillin_entries"
qc_export_description <- "amoxicillin was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_amox_records <- n_detected
```

### Amoxicillin and clavulanic acid entries [Expert knowledge checks `r qc_aclav_consistency_drug`]

```{r}
write("\to Amoxicillin and clavulanic acid check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Amoxicillin and clavulanic acid"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_aclav"
cleaning <- "none"
qc_text <- "aclav entries"
qc_idx <- qc_aclav_consistency_drug
qc_export_label <- "aclav_entries"
qc_export_description <- "Aclav was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_aclav_records <- n_detected
```

### Metronidazole entries [Expert knowledge checks `r qc_metro_consistency_drug`]

```{r}
write("\to Metronidazole check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Metronidazole"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_metronidazol"
cleaning <- "none"
qc_text <- "metronidazole entries"
qc_idx <- qc_metro_consistency_drug
qc_export_label <- "metro_entries"
qc_export_description <- "metronidazole was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_metro_records <- n_detected
```

### Cotrimoxazole entries [Expert knowledge checks `r qc_ctx_consistency_drug`]

```{r}
write("\to Cotrimoxazole check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Cotrimoxazole"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_cotrimoxazole"
cleaning <- "none"
qc_text <- "cotrimoxazole entries"
qc_idx <- qc_ctx_consistency_drug
qc_export_label <- "ctx_entries"
qc_export_description <- "cotrimoxazole was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_ctx_records <- n_detected
```

### Ciprofloxacin entries [Expert knowledge checks `r qc_cipro_consistency_drug`]

```{r}
write("\to Ciprofloxacin check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Ciprofloxacin"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_ciprofloxacin"
cleaning <- "none"
qc_text <- "ciprofloxacin entries"
qc_idx <- qc_cipro_consistency_drug
qc_export_label <- "cipro_entries"
qc_export_description <- "ciprofloxacin was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_cipro_records <- n_detected
```

### Gentamicin entries [Expert knowledge checks `r qc_genta_consistency_drug`]

```{r}
write("\to Gentamicin check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Gentamicin"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_gentamicin"
cleaning <- "none"
qc_text <- "Gentamicin entries"
qc_idx <- qc_genta_consistency_drug
qc_export_label <- "genta_entries"
qc_export_description <- "Gentamicin was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_genta_records <- n_detected
```

### Benzylpenicillin entries [Expert knowledge checks `r qc_penig_consistency_drug`]

```{r}
write("\to Benzylpenicillin check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Benzylpenicillin"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_penicillinG"
cleaning <- "none"
qc_text <- "Benzylpenicillin entries"
qc_idx <- qc_penig_consistency_drug
qc_export_label <- "penig_entries"
qc_export_description <- "Benzylpenicillin was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_penig_records <- n_detected
```

### Ceftriaxone entries [Expert knowledge checks `r qc_ceftriaxone_consistency_drug`]

```{r}
write("\to Ceftriaxone check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Ceftriaxone"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_ceftriaxone"
cleaning <- "none"
qc_text <- "Ceftriaxone entries"
qc_idx <- qc_ceftriaxone_consistency_drug
qc_export_label <- "ceftriaxone_entries"
qc_export_description <- "Ceftriaxone was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_ceftriaxone_records <- n_detected
```

### Cefixime entries [Expert knowledge checks `r qc_cefixime_consistency_drug`]

```{r}
write("\to Cefixime check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Cefixime"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_cef"
cleaning <- "none"
qc_text <- "Cefixime entries"
qc_idx <- qc_cefixime_consistency_drug
qc_export_label <- "cefixime_entries"
qc_export_description <- "Cefixime was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_cefixime_records <- n_detected
```

### Ampicillin entries [Expert knowledge checks `r qc_ampi_consistency_drug`]

```{r}
write("\to Ampicillin check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Ampicillin"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_ampicillin"
cleaning <- "none"
qc_text <- "Ampicillin entries"
qc_idx <- qc_ampi_consistency_drug
qc_export_label <- "ampicillin_entries"
qc_export_description <- "Ampicillin was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_ampi_records <- n_detected
```

### Azithromycin entries [Expert knowledge checks `r qc_azi_consistency_drug`]

```{r}
write("\to Azithromycin check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Azithromycin"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_azythromycin"
cleaning <- "none"
qc_text <- "Azithromycin entries"
qc_idx <- qc_azi_consistency_drug
qc_export_label <- "azithromycin_entries"
qc_export_description <- "Azithromycin was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_azithromycin_records <- n_detected
```

### Benzathine benzylpenicillin entries [Expert knowledge checks `r qc_benza_consistency_drug`]

```{r}
write("\to Benzathine benzylpenicillin check", stderr())
```

```{r, results='asis', eval=drug_is_not_null}
qc_description <- "All free entries should contain Benzathine benzylpenicillin"
qc_rule <- action_alert_no_modification
qc_type <- "drug_reentry_accuracy"
df <- drug_data
col_id <- "rx_benzathinepeniG"
cleaning <- "none"
qc_text <- "Benzathine benzylpenicillin entries"
qc_idx <- qc_benza_consistency_drug
qc_export_label <- "benzathinepeniG_entries"
qc_export_description <- "Benzathine benzylpenicillin was re-entered in a structured manner"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
n_benzathinepeniG_records <- n_detected
```

### Data cleaning summary

```{r}
write(" o Data cleaning summary", stderr())
```

```{r, fig.asp=1}
timci::create_drug_qc_flowchart(n_raw_drug_records,
                                n_dropped_duplicate_records,
                                n_amox_records,
                                n_aclav_records,
                                n_metro_records,
                                n_ctx_records,
                                n_cipro_records,
                                n_genta_records,
                                n_cleaned_drug_records)
```

### Data overview

```{r}
write(" o Data overview", stderr())
```

```{r, results='asis'}
skimr::skim(drug_data)
```

### Data export

```{r}
write(" o Data export", stderr())
```

```{r, eval=drug_is_not_null, results = 'asis'}
timci::dataset_export(raw_drug_data,
                      "02z",
                      "timci_day0_drug_data",
                      rctls_dir,
                      "Raw Day 0 drug re-entry data")
```

```{r export-locked-drug-data, results = 'asis'}
timci::dataset_export(drug_data,
                      "02z",
                      "timci_day0_drug_data",
                      locked_db_dir,
                      "Cleaned Day 0 drug re-entry data")
```
