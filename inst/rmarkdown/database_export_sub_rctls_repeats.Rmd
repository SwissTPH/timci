```{r}
write("Export repeat visit data and run corresponding quality checks", stderr())
```

## Repeat visit quality checks

```{r}
db_name <- "Repeat visit"
repeat_data <- facility_data %>%
  dplyr::filter(repeat_consult == 1)
n_raw_repeat_records <- nrow(repeat_data)
repeat_is_not_null <- !is.null(repeat_data)
repeat_is_not_empty <- timci::is_not_empty(repeat_data)
```

Among the **`r n_cleaned_screening_records`** cleaned screening record(s), there are **`r nrow(repeat_data)`** record(s) corresponding to repeat visit(s) within the enrolment period.

### Format raw data

```{r}
repeat_dictionary <- subset(dictionary, repeats == 1)
n_repeat_dictionary_vars <- nrow(repeat_dictionary)

raw_repeat_data <- raw_repeat_data %>% 
  dplyr::select(dplyr::any_of(c(repeat_dictionary$new,
                                "fid_from_device")))

repeat_data <- repeat_data %>% 
  dplyr::select(dplyr::any_of(c(repeat_dictionary$new,
                                "fid_from_device")))
```

There are **`r n_repeat_dictionary_vars`** variables exported from the raw `r db_name` database.

```{r, results='asis'}
repeat_dictionary %>%
  dplyr::select(new,
                old) %>%
  knitr::kable(col.names = c("Database reference",
                             "ODK reference"))
```

### Reconciliation of repeat visits with unique participants

#### Non-valid participant IDs [Context check `r qc_nonvalid_repeat`]

```{r}
write(" o Non-valid participant IDs", stderr())
```

```{r, eval=!is.null(repeat_data), results='asis'}
qc_description <- "Repeat visits are relevant only if they can be reconciled with a participant enrolled at Day 0. Reconciliation is based on the participant ID."
qc_rule <- "Keep only IDs of children who can be found in the initial Day 0 database."
qc_type <- "nonvalid_ids"
df <- repeat_data
idcol1 <- "prev_id"
refdf <- day0_data
idcol2 <- "child_id"
qc_text <- "non-valid participant IDs"
qc_idx <- qc_nonvalid_repeat
qc_export_label <- "nonvalid_pids_repeat"
qc_export_description <- "the child ID does not correspond to any ID found in the locked Day 0 database"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

```{r, eval=!is.null(cleaned_df)}
n_nonvalid_pids_repeat_records <- n_detected
repeat_data <- cleaned_df
```

### Data cleaning summary

```{r}
write(" o Data cleaning summary", stderr())
```

```{r}
n_cleaned_repeat_records <- nrow(repeat_data)
```

```{r}
timci::create_repeat_qc_flowchart(n_raw_repeat_records,
                                  n_nonvalid_pids_repeat_records,
                                  n_cleaned_repeat_records)
```

### Data overview

```{r}
write(" o Data overview", stderr())
```

```{r, results='asis', eval=timci::is_not_empty(repeat_data), results='asis'}
fig_df <- repeat_data %>%
  dplyr::mutate(week = lubridate::floor_date(as.Date(start),
                                             "week",
                                             week_start = getOption("lubridate.week.start", 1)))

fig_caption <- "Repeat data overview"
facility_col <- "fid_from_device"
date_col <- "week"
date_lbl <- "Weeks"
date_format <- "%b%y"
fill_col <- ""
comparison <- "type"

cat(knitr::knit_child('database_export_sub_facet_bar_plot.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

```{r}
repeat_data <- repeat_data %>%
  dplyr::mutate(across(c(device_id,
                         sys_submit_id,
                         form_version,
                         fid_from_device,
                         who_age_ctg,
                         dob_knwn,
                         age_mo_knwn,
                         quarter,
                         consult_reason,
                         main_cg,
                         main_cg_lbl,
                         repeat_consult),
                       factor)) %>%
  dplyr::mutate(across(c(age_yr,
                         age_mo),
                       as.integer)) %>% 
  dplyr::mutate(across(c(date_visit),
                       ~format(as.POSIXct(.),"%Y-%m-%d"))) %>% 
  dplyr::mutate(across(c(start,
                         end,
                         submission_date),
                       as.POSIXct))
```

```{r, results='asis'}
skimr::skim(repeat_data)
```

### Data export

```{r}
write(" o Data export", stderr())
```

```{r, eval=!deidentification_on, results = 'asis'}
timci::dataset_export(repeat_data,
                      "02b",
                      "timci_repeat_data",
                      rctls_dir,
                      "Raw Repeat visit data")
```

```{r, results = 'asis'}
timci::dataset_export(repeat_data,
                      "02b",
                      "timci_repeat_data",
                      locked_db_dir,
                      "Cleaned Repeat visit data")
```
