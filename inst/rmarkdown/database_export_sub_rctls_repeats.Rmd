```{r}
write("Export repeat visit data and run corresponding quality checks", stderr())
```

## Repeat visit quality checks

```{r}
db_name <- "Repeat visit"
repeat_data <- facility_data %>%
  dplyr::filter(repeat_consult == 1)
n_raw_repeat_records <- nrow(repeat_data)
repeat_is_not_null <- !is.null(repeat_data)
repeat_is_not_empty <- timci::is_not_empty(repeat_data)
```

Among the **`r n_cleaned_screening_records`** cleaned screening record(s), there are **`r nrow(repeat_data)`** record(s) corresponding to repeat visit(s) within the enrolment period.

### Format raw data

```{r}
repeat_dictionary <- subset(dictionary, repeats == 1)
n_repeat_dictionary_vars <- nrow(repeat_dictionary)
repeat_data <- repeat_data %>% 
  dplyr::select(dplyr::any_of(c(repeat_dictionary$new,
                                "fid_from_device")))
```

There are **`r n_repeat_dictionary_vars`** variables exported from the raw `r db_name` database.

```{r, results='asis'}
repeat_dictionary %>%
  dplyr::select(new,
                old) %>%
  knitr::kable(col.names = c("Database reference",
                             "ODK reference"))
```

### Reconciliation of repeat visits with unique participants

#### Repeat visits corresponding to participants enrolled outside the lock date range [Context check `r qc_pids_out_lock_range_repeat`]

```{r}
write(" o Repeat visits corresponding to participants enrolled outside the lock date range", stderr())
```

```{r, eval=!is.null(repeat_data), results='asis'}
qc_description <- paste0("Repeat visits are relevant only if associated to participants enrolled between the start date ", start_date, " and the lock date on ", lock_date, ".")
qc_rule <- "Discard repeat visits of participants who are enrolled in the Day 0 database outside the date range considered for the lock."
qc_type <- "nonvalid_ids2"
df <- repeat_data
idcol1 <- "prev_id"
refdf <- rbind(facility_data_before_start,
               facility_data_after_lock) %>%
  filter( !is.na(child_id) )
idcol2 <- "child_id"
col_date <- "date_visit"
qc_text <- "participant IDs outside the lock date range"
qc_idx <- qc_pids_out_lock_range_repeat
qc_export_label <- "pids_outside_lock_range"
qc_export_description <- "the follow-up correspond to a child who has been enrolled outside the date range for the lock"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

```{r, eval=!is.null(cleaned_df)}
n_afterlock_pids_repeat_records <- n_detected
repeat_data <- cleaned_df
```

#### Non-valid participant IDs [Context check `r qc_nonvalid_repeat`]

```{r}
write(" o Non-valid participant IDs", stderr())
```

```{r, eval=!is.null(repeat_data), results='asis'}
qc_description <- "Repeat visits are relevant only if they can be reconciled with a participant enrolled at Day 0. Reconciliation is based on the participant ID."
qc_rule <- "Keep only IDs of children who can be found in the initial Day 0 database."
qc_type <- "nonvalid_ids"
df <- repeat_data
idcol1 <- "prev_id"
refdf <- day0_data
idcol2 <- "child_id"
qc_text <- "non-valid participant IDs"
qc_idx <- qc_nonvalid_repeat
qc_export_label <- "nonvalid_pids_repeat"
qc_export_description <- "the child ID does not correspond to any ID found in the locked Day 0 database"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

```{r, eval=!is.null(cleaned_df)}
n_nonvalid_pids_repeat_records <- n_detected
repeat_data <- cleaned_df
```

### Data cleaning summary

```{r}
write(" o Data cleaning summary", stderr())
```

### Data overview

```{r, results='asis', eval=timci::is_not_empty(repeat_data), results='asis'}
fig_df <- repeat_data %>%
  dplyr::mutate(week = lubridate::floor_date(as.Date(start),
                                             "week",
                                             week_start = getOption("lubridate.week.start", 1)))

fig_caption <- "Repeat data overview"
facility_col <- "fid_from_device"
date_col <- "week"
date_lbl <- "Weeks"
date_format <- "%b%y"
fill_col <- ""
comparison <- "type"

cat(knitr::knit_child('database_export_sub_facet_bar_plot.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

```{r, results='asis'}
skimr::skim(repeat_data)
```

### Data export

```{r}
write(" o Data export", stderr())
```

```{r, eval=!deidentification_on, results = 'asis'}
timci::dataset_export(repeat_data,
                      "02b",
                      "timci_repeat_data",
                      rctls_dir,
                      "Raw Repeat visit data")
```

```{r, results = 'asis'}
timci::dataset_export(repeat_data,
                      "02b",
                      "timci_repeat_data",
                      locked_db_dir,
                      "Cleaned Repeat visit data")
```
