---
title: "Database export time-flow subsection"
author: "H. LANGET"
date: "2021-12-22"
output: pdf_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

## Observations by children

```{r}
db_name <- "time-flow main"
qc_tf_nonvalid_ids <- "DQC_TF_01"
```

```{r}
tf_data_main <- tf_data[[1]]
n_raw_tf_data_main <- nrow(tf_data_main)
```

```{r}
locked_tf_data_main <- tf_data_main %>%
  dplyr::filter(date <= as.Date(lock_date, "%Y-%m-%d"))
```

There are **`r n_raw_tf_data_main`** records between **`r spa_start_date`** and **`r lock_date`** in the raw `r db_name` database.

### Non-valid participant IDs [compliance check `r qc_tf_nonvalid_ids`]

```{r}
cleaned_df <- NULL
```

```{r, eval=!is.null(locked_tf_data_main), results='asis'}
qc_description <- "Children can be part of the time-flow data even if they have not been enrolled in the RCT/LS and are not on their Day 0 visit."
qc_rule <- "Flag with value 1 in column *matched* the IDs of children who are found in the locked Day 0 database."
qc_type <- "spatf_nonvalid_ids"
df <- locked_tf_data_main
idcol1 <- "child_identification-pid"
refdf <- facility_data
idcol2 <- "child_id"
qc_text <- "participant ID not valid"
qc_idx <- qc_spa_sco_nonvalid_ids
qc_export_label <- "timci_timeflow_data_unknown_ids"
qc_export_description <- "child IDs are not found in the Day 0 dataset"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

```{r, eval=!is.null(cleaned_df)}
locked_tf_data_main <- cleaned_df
```

### Data cleaning summary

There are **`r nrow(locked_tf_data_main)`** records in the locked `r db_name` database.

### Data overview

```{r, results='asis'}
skimr::skim(locked_tf_data_main)
```

### Export

```{r time-flow-main-verbose}
write("Export time-flow main data", stderr())
```

```{r time-flow-export-data, results = 'asis', eval=!is.null(tf_data[[1]])}
timci::dataset_export(tf_data_main,
                      "15a",
                      "timci_timeflow_data",
                      params$spa_dir,
                      "Raw time-flow data")
```

```{r, results='asis'}
timci::dataset_export(locked_tf_data_main,
                      "15a",
                      "timci_timeflow_data",
                      locked_db_dir,
                      "Time-flow step data")
```

## Steps

```{r}
db_name <- "time-flow step"
qc_tf_negative_times <- "DQC_TF_02"
```

```{r}
tf_data_steps <- tf_data[[2]]
n_raw_tf_data_steps <- nrow(tf_data_steps)
```

```{r}
tf_data_steps <- tf_data_steps %>%
  dplyr::mutate(step_duration_in_seconds = difftime(strptime(time_end, "%Y-%m-%d %H:%M:%S"),
                                                    strptime(time_start, "%Y-%m-%d %H:%M:%S")))
```

There are **`r n_raw_tf_data_steps`** records in the raw `r db_name` database.

### Negative step duration [Logic check `r qc_tf_negative_times`]

```{r}
cleaned_df <- NULL
```

```{r, eval=!is.null(tf_data_steps), results='asis'}
qc_description <- "Detect negative step durations and how frequently it happened for a given time-flow observation to assess the quality of the whole time-flow record."
qc_rule <- "Delete steps where the duration is negative."
qc_type <- "tf_negative_value"
df <- tf_data_steps
qc_text <- "negative duration"
qc_idx <- qc_tf_negative_times
qc_export_label <- "timci_timeflow_negative_durations"
qc_export_description <- "step duration is negative"
cat(knitr::knit_child('database_export_sub_quality_check.Rmd',
                      envir = environment(),
                      quiet = TRUE))
```

```{r, eval=!is.null(cleaned_df)}
locked_tf_data_steps <- cleaned_df
```

### Export

```{r time-flow-step-verbose}
write("Export time-flow step data", stderr())
```

```{r time-flow-export-steps, results = 'asis', eval=!is.null(tf_data_steps)}
timci::dataset_export(tf_data_steps,
                      "15b",
                      "timci_timeflow_steps",
                      params$spa_dir,
                      "Time-flow step data")
```

```{r, results='asis', eval=!is.null(locked_tf_data_steps)}
timci::dataset_export(locked_tf_data_steps,
                      "15b",
                      "timci_timeflow_steps",
                      locked_db_dir,
                      "Time-flow step data")
```

## Audit data

```{r}
i <- length(tf_data)
```

### Export

```{r time-flow-audit-verbose}
write("Export time-flow audit data", stderr())
```

```{r time-flow-export-audit, results = 'asis', eval=!is.null(tf_data[[i]])}
timci::dataset_export(tf_data[[i]],
                      "15z",
                      "timci_timeflow_audit",
                      params$spa_dir,
                      "Time-flow audit log data")
```
